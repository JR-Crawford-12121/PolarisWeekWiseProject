// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EventStatus {
  proposed
  confirmed
  dismissed
}

enum SourceType {
  syllabus
  email
  manual
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  courses            Course[]
  events             Event[]
  tasks              Task[]
  userIntegrations   UserIntegration[]
  emailMessages      EmailMessage[]

  @@map("users")
}

model Course {
  id          String   @id @default(cuid())
  userId      String
  name        String
  code        String?  // e.g., "CS101"
  term        String?  // e.g., "Fall 2024"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  events Event[]

  @@unique([userId, name])
  @@map("courses")
}

model Event {
  id          String      @id @default(cuid())
  userId      String
  courseId    String?
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  source      SourceType  @default(manual)
  sourceId    String?     // ID from source (syllabus section, email ID, etc.)
  dedupeKey   String?     // For deduplication across sources
  confidence  Float?      // LLM confidence score (0-1)
  status      EventStatus @default(proposed)
  timezone    String      @default("America/Chicago")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  course       Course?         @relation(fields: [courseId], references: [id], onDelete: SetNull)
  sourceEvidence SourceEvidence[]
  tasks        Task[]

  @@index([userId, startTime])
  @@index([dedupeKey])
  @@index([source, sourceId])
  @@map("events")
}

model Task {
  id          String      @id @default(cuid())
  userId      String
  eventId     String?
  title       String
  description String?
  dueDate     DateTime?
  completed   Boolean     @default(false)
  source      SourceType  @default(manual)
  sourceId    String?     // ID from source
  dedupeKey   String?     // For deduplication
  confidence  Float?      // LLM confidence score (0-1)
  status      EventStatus @default(proposed)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  event        Event?          @relation(fields: [eventId], references: [id], onDelete: SetNull)
  sourceEvidence SourceEvidence[]

  @@index([userId, dueDate])
  @@index([dedupeKey])
  @@index([source, sourceId])
  @@map("tasks")
}

model SourceEvidence {
  id          String   @id @default(cuid())
  eventId     String?
  taskId      String?
  source      SourceType
  sourceId    String
  content     String   // Extracted text or email content
  metadata    Json?    // Additional metadata (page number, email headers, etc.)
  s3Key       String?  // S3 key for stored file (PDF, etc.)
  extractionJson Json? // Full LLM extraction JSON
  createdAt   DateTime @default(now())

  event Event? @relation(fields: [eventId], references: [id], onDelete: Cascade)
  task  Task?  @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([source, sourceId])
  @@map("source_evidence")
}

model EmailMessage {
  id            String   @id @default(cuid())
  userId        String
  messageId     String   @unique // Gmail message ID
  threadId      String?
  subject       String
  from          String
  to            String[]
  cc            String[]
  bcc           String[]
  bodyText      String?
  bodyHtml      String?
  receivedAt    DateTime
  isImportant   Boolean  @default(false)
  processed     Boolean  @default(false)
  processedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, receivedAt])
  @@index([userId, isImportant, processed])
  @@map("email_messages")
}

model UserIntegration {
  id            String   @id @default(cuid())
  userId        String
  provider      String   // "gmail", "google_calendar", etc.
  providerUserId String? // User ID from provider
  accessToken   String?  // Encrypted access token
  refreshToken  String?  // Encrypted refresh token
  tokenExpiresAt DateTime?
  scope         String?  // OAuth scopes
  metadata      Json?    // Additional provider-specific data
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("user_integrations")
}
